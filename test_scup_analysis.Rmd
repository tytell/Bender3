---
title: "R Notebook"
output: html_notebook
---

```{r setup}
library(tidyverse)
library(here)
library(patchwork)
library(plotly)

source('bender_data.R')
```

```{r}
datadir <- '/Users/etytel01/Documents/2021/Scup/data/rawdata/2021-07-15'
```

```{r}
filename <- 'scup14_008.h5'
```

```{r}
data <- load_bender_data(file.path(datadir, filename), filtercutoff = 30.0)
```

```{r}
cycledata <- load_cycle_data(file.path(datadir, filename), data)
```

```{r}
p1 <-
  ggplot(data, aes(x = t.s, y = torque.Nm.orig)) +
  geom_path() +
  geom_path(aes(y = torque.Nm), color="red")
  geom_rect(data = cycledata, aes(xmin = t_act_on.s, xmax = t_act_off.s, fill = side,
                                  ymin = min(data$torque.Nm), ymax = max(data$torque.Nm)),
            alpha = 0.5, inherit.aes = FALSE)

ggplotly(p1)
```


```{r}
data <-
  left_join(data, cycledata, by='halfcycle') %>%
  group_by(halfcycle) %>%
  mutate(is_stim = (t.s >= t_act_on.s) & (t.s < t_act_off.s),
         is_stim = factor(case_when(is.na(is_stim) ~ 'passive',
                                    is_stim ~ 'on',
                                    !is_stim ~ 'off')))
```

```{r}
data %>%
  filter(t.norm > 0.5) %>%
  ggplot(aes(x = curve.invm, y = torque.Nm, color=is_stim)) +
  geom_path() +
  facet_grid(frequency.Hz ~ fct_cross(is_active, factor(amplitude.deg)))
```

```{r}
cycdata2 <- calculate_cycle_data()
```

